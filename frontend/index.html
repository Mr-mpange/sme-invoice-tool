<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>SME Invoice Tool</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet" />
  <style>
    :root { --bg: #0b1020; --card: #0e1630; --text: #e6ecff; --muted: #a7b4d6; --accent: #4f7cff; --border: #223059; }
    * { box-sizing: border-box; }
    body { font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 0; padding: 0 16px 48px; background: var(--bg); color: var(--text); }
    header { display: flex; align-items: baseline; gap: 12px; padding: 24px 0; }
    h1 { margin: 0; font-size: 24px; letter-spacing: -0.3px; }
    h2 { margin: 0 0 12px; font-size: 16px; color: var(--muted); font-weight: 600; }
    section { background: var(--card); padding: 16px; margin: 12px 0; border: 1px solid var(--border); border-radius: 12px; }
    form { display: flex; gap: 8px; flex-wrap: wrap; }
    input, button { padding: 10px 12px; font-size: 14px; border-radius: 8px; border: 1px solid var(--border); background: #0b1430; color: var(--text); }
    input::placeholder { color: #8293c9; }
    button { cursor: pointer; background: var(--accent); border-color: var(--accent); color: white; font-weight: 600; }
    button.secondary { background: transparent; color: var(--text); border-color: var(--border); }
    pre { background: #0a0f24; color: #d2e3ff; padding: 12px; border-radius: 10px; overflow: auto; border: 1px solid var(--border); }
    #env { font-size: 12px; color: var(--muted); }
    .stack { display: grid; gap: 8px; }
  </style>
</head>
<body>
  <div id="root"></div>

  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/babel-standalone@6/babel.min.js"></script>
  <script type="text/babel">
    const { useState, useEffect } = React;

    const base = '';
    async function fetchJson(path, opts) {
      const res = await fetch(base + path, opts);
      const ct = res.headers.get('content-type') || '';
      if (ct.includes('text/plain')) return res.text();
      return res.json();
    }
    const toText = (data) => typeof data === 'string' ? data : JSON.stringify(data, null, 2);

    function Section({ title, children }) {
      return (
        <section>
          <h2>{title}</h2>
          <div className="stack">{children}</div>
        </section>
      );
    }

    function App() {
      const [env, setEnv] = useState('');
      const [healthOut, setHealthOut] = useState('');
      const [sendInvoiceOut, setSendInvoiceOut] = useState('');
      const [testSmsOut, setTestSmsOut] = useState('');
      const [createInvoiceOut, setCreateInvoiceOut] = useState('');
      const [checkoutOut, setCheckoutOut] = useState('');
      const [ussdOut, setUssdOut] = useState('');

      useEffect(() => {
        (async () => {
          try {
            const cfg = await fetchJson('/config');
            setEnv(`env: ${cfg.atEnv} (sandbox=${cfg.isSandbox})`);
          } catch {}
        })();
      }, []);

      async function onHealth() {
        setHealthOut(toText(await fetchJson('/health')));
      }

      async function onSendInvoice(e) {
        e.preventDefault();
        const fd = new FormData(e.currentTarget);
        const body = Object.fromEntries(fd.entries());
        setSendInvoiceOut(toText(await fetchJson('/send-invoice', {
          method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(body)
        })));
      }

      async function onTestSms(e) {
        e.preventDefault();
        const fd = new FormData(e.currentTarget);
        const body = Object.fromEntries(fd.entries());
        setTestSmsOut(toText(await fetchJson('/test-sms', {
          method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(body)
        })));
      }

      async function onCreateInvoice(e) {
        e.preventDefault();
        const fd = new FormData(e.currentTarget);
        const body = Object.fromEntries(fd.entries());
        setCreateInvoiceOut(toText(await fetchJson('/invoices', {
          method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(body)
        })));
      }

      async function onCheckout(e) {
        e.preventDefault();
        const fd = new FormData(e.currentTarget);
        const body = Object.fromEntries(fd.entries());
        setCheckoutOut(toText(await fetchJson('/payments/checkout', {
          method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(body)
        })));
      }

      async function onUssd(e) {
        e.preventDefault();
        const fd = new FormData(e.currentTarget);
        const body = new URLSearchParams(fd);
        const res = await fetch('/ussd', { method: 'POST', headers: { 'Content-Type': 'application/x-www-form-urlencoded' }, body });
        setUssdOut(await res.text());
      }

      return (
        <main>
          <header>
            <h1>SME Invoice Tool</h1>
            <div id="env">{env}</div>
          </header>

          <Section title="Health">
            <div>
              <button onClick={onHealth}>Check /health</button>
            </div>
            <pre>{healthOut}</pre>
          </Section>

          <Section title="Send Invoice (SMS)">
            <form onSubmit={onSendInvoice}>
              <input type="text" name="phoneNumber" placeholder="+2557XXXXXXX" required />
              <input type="number" name="amount" placeholder="Amount" required />
              <input type="text" name="invoiceId" placeholder="INV-001" required />
              <button type="submit">Send</button>
            </form>
            <pre>{sendInvoiceOut}</pre>
          </Section>

          <Section title="Test SMS">
            <form onSubmit={onTestSms}>
              <input type="text" name="to" placeholder="+2557XXXXXXX" required />
              <input type="text" name="message" placeholder="Hello" required />
              <button type="submit">Send</button>
            </form>
            <pre>{testSmsOut}</pre>
          </Section>

          <Section title="Create Invoice">
            <form onSubmit={onCreateInvoice}>
              <input type="text" name="customerPhone" placeholder="+2557XXXXXXX" required />
              <input type="number" name="amount" placeholder="Amount" required />
              <input type="text" name="description" placeholder="Description" />
              <button type="submit">Create</button>
            </form>
            <pre>{createInvoiceOut}</pre>
          </Section>

          <Section title="Payments Checkout">
            <form onSubmit={onCheckout}>
              <input type="text" name="phoneNumber" placeholder="+2557XXXXXXX" required />
              <input type="number" name="amount" placeholder="1000" required />
              <input type="text" name="currency" placeholder="TZS" defaultValue="TZS" />
              <input type="text" name="invoiceId" placeholder="INV-001" />
              <button type="submit">Prompt Payment</button>
            </form>
            <pre>{checkoutOut}</pre>
          </Section>

          <Section title="USSD (simulate via POST)">
            <form onSubmit={onUssd}>
              <input type="text" name="sessionId" placeholder="123" required />
              <input type="text" name="serviceCode" placeholder="*384*XXXX#" required />
              <input type="text" name="phoneNumber" placeholder="+2557XXXXXXX" required />
              <input type="text" name="text" placeholder="e.g. 1*INV-001*15000" />
              <button type="submit">Send</button>
            </form>
            <pre>{ussdOut}</pre>
          </Section>
        </main>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>